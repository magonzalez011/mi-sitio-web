<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comandas - Nutrici√≥n</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { background: #e8f1f8; }
    .form-container { background-image: url("img/hospital.jpg"); background-size: cover; background-repeat: no-repeat; background-position: left; padding: 25px; border-radius: 12px; box-shadow: 0px 3px 10px rgba(0,0,0,0.1); max-width: 1100px; }
    .form-label { font-weight: bold; }
    .btn-primary, .btn-success, .btn-danger { border-radius: 10px; }
    input, select, textarea { border-radius: 10px !important; }
</style>
</head>
<body>

<div class="container-fluid my-4 px-3 px-md-5 d-flex justify-content-center">
<div class="form-container w-100">
    <!-- LOGO -->
    <div class="text-center mb-4">  
        <img src="img/LOGO.jfif" style="float:center; margin-right: 20px;">
    </div>

<h1 class="text-center mb-4" style="color:#053563;">Registro de Comandas</h1>

<form id="formComanda" class="row g-3">
    <!-- Campos del formulario -->
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">N√∫mero de Comanda</label>
        <input type="text" class="form-control" id="numeroComanda" readonly>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Timestamp</label>
        <input type="text" class="form-control" id="timestamp" readonly>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Fecha</label>
        <input type="date" class="form-control" id="fecha" required>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Piso</label>
        <input type="text" class="form-control" id="piso">
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Habitaci√≥n</label>
        <input type="text" class="form-control" id="habitacion">
    </div>
    <div class="col-12 col-md-9">
        <label class="form-label">Paciente</label>
        <input type="text" class="form-control" id="paciente">
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <label class="form-label">Fecha de Nacimiento</label>
        <input type="date" class="form-control" id="fechaNacimiento">
    </div>
    <div class="col-12">
        <label class="form-label">Alergias</label>
        <textarea id="alergias" rows="2" class="form-control"></textarea>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <label class="form-label">Tiempo de Comida</label>
        <select id="tiempoComida" class="form-select" required>
            <option>Desayuno</option>
            <option>Comida</option>
            <option>Cena</option>
        </select>
    </div>
    <div class="col-12 col-sm-6 col-md-4">
        <label class="form-label">Dietista</label>
        <select id="dietista" class="form-select" required>
            <option>Aly</option>
            <option>Arantza</option>
            <option>Fernanda</option>
            <option>Fernando</option>
            <option>Mariana</option>
            <option>Ver√≥nica</option>
        </select>
    </div>
    <div class="col-12 col-md-4">
        <label class="form-label">Diagn√≥stico</label>
        <input type="text" class="form-control" id="diagnostico">
    </div>
    <div class="col-12 col-md-4">
        <label class="form-label">Tipo de dieta</label>
        <select class="form-select" id="tipoDieta" required>
            <option>Astringente</option>
            <option>Blanda</option>
            <option>Diab√©tico</option>
            <option>Hipos√≥dica</option>
            <option>L√≠quida</option>
            <option>Nefr√≥pata</option>
            <option>Normal</option>
            <option>Picado Fino</option>
            <option>Papillas</option>
        </select>
    </div>
    <div class="col-12">
        <label class="form-label">Alimento solicitado</label>
        <textarea class="form-control" id="alimento" rows="2"></textarea>
    </div>
    <div class="col-12 col-md-4">
        <div class="form-check mt-4">
            <input type="checkbox" id="estado" class="form-check-input">
            <label class="form-check-label">Realizado</label>
        </div>
    </div>
    <div class="col-12">
        <label class="form-label">Observaciones</label>
        <textarea class="form-control" id="observaciones" rows="2"></textarea>
    </div>

    <!-- Botones -->
         
    <div class="col-12">
    <button type="button" class="btn btn-secondary" onclick="abrirTicket()">üßæ Imprimir Ticket</button>
    </div>

    <div class="col-12">
    <button type="button" class="btn btn-primary" onclick="abrirPDF()">üìÑ Imprimir 2 copias</button>
    </div>

    <div class="col-12">
        <button type="button" class="btn btn-dark w-100" onclick="guardarComanda()">Guardar Comanda</button>
    </div>

    <div class="col-12">
        <button type="button" class="btn btn-danger" onclick="verificarPIN()">üîê Resetear n√∫mero de comandas</button>
    </div>

    <div class="col-12">
        <button type="button" class="btn btn-warning" onclick="abrirHistorial()">üìã Historial de comandas</button>
    </div>

</form>

</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGj9B55vHP689OLRsk22zt0p_M7Qm6lruv5BLQn0wGzoQwJSQUEK-5M3UVQ3VXLVR-mQ/exec"; // <- tu URL
const PIN_RESET = "4321";

// Convierte fecha yyyy-mm-dd -> dd/mm/yyyy
function convertirFechaADDMMAAAA(fechaISO) {
    if (!fechaISO) return "";
    const partes = fechaISO.split("-");
    if (partes.length !== 3) return fechaISO;
    return partes[2] + "/" + partes[1] + "/" + partes[0];
}

// Inicializa n√∫mero de comanda y timestamp
async function inicializar() {
    try {
        const res = await fetch(`${SCRIPT_URL}?accion=siguiente`);
        const data = await res.json();
        document.getElementById("numeroComanda").value = String(data.numeroComanda).padStart(3,"0");
        document.getElementById("timestamp").value = new Date().toLocaleString(); // mantiene timestamp
    } catch(err) {
        console.error("Error obteniendo n√∫mero de comanda:", err);
        alert("No se pudo obtener el n√∫mero de comanda desde la hoja.");
    }
}

// Guardar comanda en Sheets
async function guardarComanda() {
    const datos = {
        numeroComanda: document.getElementById("numeroComanda").value,
        timestamp: document.getElementById("timestamp").value,
        fecha: convertirFechaADDMMAAAA(document.getElementById("fecha").value),
        piso: document.getElementById("piso").value,
        habitacion: document.getElementById("habitacion").value,
        paciente: document.getElementById("paciente").value,
        fechaNacimiento: convertirFechaADDMMAAAA(document.getElementById("fechaNacimiento").value),
        alergias: document.getElementById("alergias").value,
        tiempoComida: document.getElementById("tiempoComida").value,
        dietista: document.getElementById("dietista").value,
        diagnostico: document.getElementById("diagnostico").value,
        tipoDieta: document.getElementById("tipoDieta").value,
        alimento: document.getElementById("alimento").value,
        estado: document.getElementById("estado").checked ? "Realizado" : "Pendiente",
        observaciones: document.getElementById("observaciones").value
    };

    try {
        await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(datos) });
        alert("Comanda guardada correctamente ‚úî");
        document.getElementById("formComanda").reset();
        inicializar();
    } catch(err) {
        console.error("Error guardando comanda:", err);
        alert("No se pudo guardar la comanda.");
    }
}

// Reset con PIN
async function verificarPIN() {
    const pin = prompt("Ingrese el PIN para resetear:");
    if(pin === PIN_RESET){
        if(confirm("¬øDesea reiniciar el contador de comandas a 001?")){
            await fetch(`${SCRIPT_URL}?accion=reset`);
            alert("Contador reiniciado ‚úî");
            inicializar();
        }
    } else {
        alert("PIN incorrecto ‚ùå");
    }
}

// Ejecutar al cargar la p√°gina
window.onload = inicializar;

let ticketWindow = null;

function abrirTicket(){
    ticketWindow = window.open(
        "ticket.html",
        "ticket",
        "width=320,height=600"
    );

    const datos = {
        fecha: document.getElementById("fecha").value,
        numeroComanda: document.getElementById("numeroComanda").value,
        paciente: document.getElementById("paciente").value,
        fechaNacimiento: document.getElementById("fechaNacimiento").value,
        piso: document.getElementById("piso").value,
        habitacion: document.getElementById("habitacion").value,
        tiempoComida: document.getElementById("tiempoComida").value,
        tipoDieta: document.getElementById("tipoDieta").value,
        diagnostico: document.getElementById("diagnostico").value,
        alimento: document.getElementById("alimento").value,
        alergias: document.getElementById("alergias").value,
        observaciones: document.getElementById("observaciones").value
    };

    setTimeout(()=>{
        ticketWindow.postMessage(datos,"*");
    },500);
}

function abrirPDF(){
    const win = window.open(
        "pdf-4copias.html",
        "pdf",
        "width=900,height=700"
    );

    const datos = {
        fecha: document.getElementById("fecha").value,
        numeroComanda: document.getElementById("numeroComanda").value,
        paciente: document.getElementById("paciente").value,
        fechaNacimiento: document.getElementById("fechaNacimiento").value,
        piso: document.getElementById("piso").value,
        habitacion: document.getElementById("habitacion").value,
        tiempoComida: document.getElementById("tiempoComida").value,
        tipoDieta: document.getElementById("tipoDieta").value,
        diagnostico: document.getElementById("diagnostico").value,
        alimento: document.getElementById("alimento").value,
        alergias: document.getElementById("alergias").value,
        observaciones: document.getElementById("observaciones").value
    };

    setTimeout(()=>{
        win.postMessage(datos,"*");
    },500);
}

function abrirHistorial(){
  window.open(
    "historial.html",
    "historial",
    "width=1200,height=700"
  );
}


</script>

</body>
</html>
